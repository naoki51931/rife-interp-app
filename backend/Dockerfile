# ============================================================
# 1️⃣ ベースイメージ：CUDA + cuDNN + Python 環境
# ============================================================
FROM nvidia/cuda:12.2.2-cudnn8-runtime-ubuntu22.04

# システムパッケージのインストール
RUN apt-get update && apt-get install -y \
    python3 python3-pip git wget unzip ffmpeg libgl1 \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# ============================================================
# 2️⃣ 作業ディレクトリ設定
# ============================================================
WORKDIR /app

# FastAPI アプリのコードをコピー
COPY app/ /app/

# ============================================================
# 3️⃣ RIFE コードを配置
# ============================================================
# RIFE本体をclone
RUN git clone --depth=1 https://github.com/hzwer/Practical-RIFE.git /opt/rife

# RIFE依存パッケージをインストール
RUN pip3 install --no-cache-dir -r /opt/rife/requirements.txt

# ============================================================
# 4️⃣ FastAPI 用の依存パッケージをインストール
# ============================================================
COPY app/requirements.txt /app/requirements.txt

RUN pip3 install --no-cache-dir -r /app/requirements.txt

# ============================================================
# 5️⃣ モデルフォルダをマウント可能に
# ============================================================
# /opt/rife/models はホスト側 ./models をバインドマウント
VOLUME ["/opt/rife/models"]

# ============================================================
# 6️⃣ ポート・エントリーポイント
# ============================================================
EXPOSE 8000

# データ保存ディレクトリ
RUN mkdir -p /data
VOLUME ["/data"]

# ============================================================
# 7️⃣ 環境変数
# ============================================================
ENV PYTHONUNBUFFERED=1
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# ============================================================
# 8️⃣ 実行コマンド
# ============================================================
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]

